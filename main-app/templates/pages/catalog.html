{% extends '_base.html' %}
{% load static %}


{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/catalog.css' %}">
{% endblock styles %}

{% block content %}

<main class="catalog-main">
  <section class="cat-head">
    <div class="container">
      <h1 class="section-title" style="margin-bottom:16px">–ö–∞—Ç–∞–ª–æ–≥</h1>
      <div class="cat-row" id="catRow">
        <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º...">
      </div>

      <div class="cat-row" id="catFilters" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <button class="cat chip is-active" data-cat="all" role="tab" aria-selected="true">–í—Å–µ</button>
        {% if categories %}
          {% for c in categories %}
            <button class="cat chip" data-cat="{{ c.id }}" role="tab" aria-selected="false">{{ c.name }}</button>
          {% endfor %}
        {% else %}
          <button class="cat chip" data-cat="1" role="tab" aria-selected="false">–†—É–±–∏–Ω—ã (Gems)</button>
          <button class="cat chip" data-cat="2" role="tab" aria-selected="false">–û—Å–∫–æ–ª–∫–∏ (Shards)</button>
          <button class="cat chip" data-cat="3" role="tab" aria-selected="false">–ù–∞–±–æ—Ä—ã/—Ä–µ—Å—É—Ä—Å—ã</button>
          <button class="cat chip" data-cat="4" role="tab" aria-selected="false">–ü—Ä–æ–ø—É—Å–∫–∞</button>
          <button class="cat chip" data-cat="5" role="tab" aria-selected="false">–£—Å–ª—É–≥–∏</button>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="catalog-grid">
    <div class="container grid" id="grid">
      {% for product in products %}

      <article class="p-card" data-cat="{{ product.category_id }}">
        <div class="p-media" aria-hidden="true">
            {% if product.poster %}
              <img src="{{ product.poster.url }}" alt="{{ product.name }}">
            {% elif product.image_url %}
              <img src="{{ product.image_url }}" alt="{{ product.name }}">
            {% else %}
              <img src="{% static 'images/no-image.png' %}" alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
            {% endif %}
        </div>
        <div class="p-body">
          <h3 class="p-title">{{product.name}}</h3>
          <p class="p-desc">{{product.description}}</p>
          <div class="p-foot">
            <div class="p-price">{{product.price}}‚ÇΩ</div>
            <button class="btn p-buy">–ö—É–ø–∏—Ç—å</button>
          </div>
        </div>
      </article>

      {% endfor %}

    </div>
    <div id="noResults" class="no-results" style="display:none">
      –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòï
    </div>
  </section>
</main>


<script>
  const searchInput = document.getElementById('searchInput');
  const cards = Array.from(document.querySelectorAll('.p-card'));
  const noResults = document.getElementById('noResults');
  const catFilters = document.getElementById('catFilters');
  let activeCat = 'all';

  function applyFilters() {
    const q = (searchInput.value || '').toLowerCase();
    let visible = 0;

    cards.forEach(card => {
      const title = card.querySelector('.p-title').textContent.toLowerCase();
      const desc  = card.querySelector('.p-desc').textContent.toLowerCase();
      const catId = card.getAttribute('data-cat');

      const matchesText = !q || title.includes(q) || desc.includes(q);
      const matchesCat  = activeCat === 'all' || catId === String(activeCat);

      const show = matchesText && matchesCat;
      card.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    noResults.style.display = visible === 0 ? 'block' : 'none';
  }

  searchInput.addEventListener('input', applyFilters);

  catFilters.addEventListener('click', (e) => {
    const btn = e.target.closest('.chip[data-cat]');
    if (!btn) return;

    catFilters.querySelectorAll('.chip').forEach(b => {
      b.classList.remove('is-active');
      b.setAttribute('aria-selected', 'false');
    });
    btn.classList.add('is-active');
    btn.setAttribute('aria-selected', 'true');

    activeCat = btn.dataset.cat;
    applyFilters();
  });

  applyFilters();

  document.querySelectorAll('.p-buy').forEach(b => {
    b.addEventListener('click', () => alert('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ ‚Äî —Å–∫–æ—Ä–æ.'));
  });
</script>


{% endblock content %}