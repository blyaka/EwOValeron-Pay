{% extends '_base.html' %}
{% load static %}
{% load pay_extras %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/base_lk.css'%}">
<link rel="stylesheet" href="{% static 'css/pages/payment-links.css'%}">
{% endblock styles %}

{% block content %}


{% include 'includes/sub_nav_lk.html' %}


<main>



  <section class="ps-filters">

    <button class="ps-filters-toggle" type="button" aria-expanded="false">
      <span>Фильтры</span>
      <svg class="chev" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M6.7 8.7a1 1 0 0 1 1.4 0L12 12.6l3.9-3.9a1 1 0 1 1 1.4 1.4l-4.6 4.6a1 1 0 0 1-1.4 0L6.7 10.1a1 1 0 0 1 0-1.4z"
          fill="currentColor" />
      </svg>
    </button>

    <div class="ps-filters-container">
      <button class="f-icon" id="filtersReset" aria-label="Сбросить фильтры" title="Сбросить фильтры">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M3 5h18l-6.5 7.5v5.75l-5 2.5V12.5L3 5z" />
        </svg>
      </button>

      <label class="chip chip--toggle" data-chip="date">
        <span class="chip__title">Дата</span>
        <span class="chip__body">
          <input type="date" id="fDateFrom" placeholder="с">
          <input type="date" id="fDateTo" placeholder="по">
        </span>
      </label>

      <!-- Сумма -->
      <label class="chip chip--toggle" data-chip="amount">
        <span class="chip__title">Сумма платежа</span>
        <span class="chip__body">
          <input type="number" id="fAmtMin" inputmode="numeric" placeholder="от">
          <input type="number" id="fAmtMax" inputmode="numeric" placeholder="до">
        </span>
      </label>

      <!-- Tag -->
      <label class="chip chip--toggle" data-chip="tag">
        <span class="chip__title">Tag</span>
        <span class="chip__body">
          <input type="text" id="fTag" placeholder="например: promo">
        </span>
      </label>

      <label class="chip grow">
        <input type="text" id="fOrder" placeholder="Точечный поиск по: Order ID">
      </label>

      <label class="chip grow">
        <input type="text" id="fComment" placeholder="Поиск по: Комментарию">
      </label>
    </div>


    <a href="" class="chip">Добавить ссылку</a>


  </section>


  <!-- Скрипт для мобильных фильтров -->
  <script>
    (() => {
      const section = document.querySelector('.ps-filters');
      if (!section) return;
      const toggle = section.querySelector('.ps-filters-toggle');
      const box = section.querySelector('.ps-filters-container');

      const mq = window.matchMedia('(max-width: 767px)');
      const setup = () => {
        if (mq.matches) {
          box.hidden = true;
          section.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'false');
        } else {
          box.hidden = false;
          box.style.maxHeight = 'none';
          section.classList.remove('is-open');
          toggle.setAttribute('aria-expanded', 'true');
        }
      };
      setup();
      mq.addEventListener('change', setup);

      toggle.addEventListener('click', () => {
        const open = section.classList.toggle('is-open');
        toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        box.hidden = !open;
      });
    })();
  </script>




  <section class="ps-wrap">
    <div class="ps-scroll">
      <table class="ps-table" id="paymentsTable">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Order ID</th>
            <th>Сумма платежа&nbsp;<small>(₽)</small></th>
            <th>Комментарий</th>
            <th>Tag</th>
            <th>Срок ссылки</th>
            <th>Статус</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr>
            <td>{{ p.created_at|date:"d.m.Y | H:i" }}</td>
            <td>{{ p.order_id }}</td>
            <td>{{ p.amount }}</td>
            <td>{{ p.comment|default:"" }}</td>
            <td>
              {% if p.tag_obj %}{{ p.tag_obj.name }}{% elif p.tag %}{{ p.tag }}{% else %}—{% endif %}
            </td>
            <td>{{ p.expires_at|ttl }}</td>
            <td>
              {% if p.status|lower in "pending,created" %}Активна{% else %}{{ p.status }}{% endif %}
            </td>
            <td>
              <button class="btn small copy-btn" data-url="{{ p.public_url }}">Скопировать</button>
              <a class="btn small" target="_blank" rel="noopener" href="{{ p.public_url }}">Открыть</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align:center;color:var(--muted)">Активных ссылок нет</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>




  <div class="pagination" data-prev="{{ prev_url }}" data-next="{{ next_url }}">
    <button class="page-btn prev" aria-label="Предыдущая" {% if not page_obj.has_previous %}disabled
      aria-disabled="true" {% endif %}>
      <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
          fill="white" />
      </svg>
    </button>

    {% for p in pages %}
    {% if p.disabled %}
    <a href="#" class="page-num disabled" tabindex="-1" aria-disabled="true">…</a>
    {% else %}
    <a href="{{ p.url }}" class="page-num{% if p.active %} active{% endif %}">{{ p.label }}</a>
    {% endif %}
    {% endfor %}

    <button class="page-btn next" aria-label="Следующая" {% if not page_obj.has_next %}disabled aria-disabled="true" {% endif %}>
      <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg"
        style="transform: rotate(180deg);">
        <path
          d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
          fill="white" />
      </svg>
    </button>
  </div>





  <!-- Модалка генерации -->
  <div class="modal" id="genModal" aria-hidden="true">
    <div class="modal__bg" id="genClose"></div>
    <div class="modal__box">
      <h2>Генерация ссылки</h2>

      <button class="modal__close" id="modalCloseBtn" aria-label="Закрыть модалку">×</button>


      <div class="form-row">
        <div class="order-id-container">
          <label class="order-label">Order ID:</label>
          <div class="order-id" id="orderId">-</div>
        </div>

        <input type="hidden" name="order_id" id="order_id">
        <input type="hidden" name="order_seq" id="order_seq">
        <input type="hidden" name="order_prefix" id="order_prefix">
        <input type="hidden" name="order_date" id="order_date">

        <p class="hint">Запиши этот ID — он нужен для отслеживания платежа.</p>
      </div>

      <div class="form-row">
        <label for="amount">Сумма заказа (₽)</label>
        <input type="number" id="amount" placeholder="Введите сумму">
      </div>

      <div class="form-row">
        <label>Время жизни ссылки</label>
        <div class="inline">
          <input type="number" id="expH" min="0" placeholder="часы">
          <input type="number" id="expM" min="0" placeholder="минуты">
        </div>
        <p class="hint" id="timeHint">Ссылка активна: 0д 0ч 0м</p>
      </div>

      <div class="form-row">
        <label for="buyerEmail">Email покупателя</label>
        <input type="email" id="buyerEmail" name="email" placeholder="client@example.com" required>
        <p class="hint">На этот адрес придёт платёжная информация.</p>
      </div>

      <div class="form-row">
        <label for="payMethod">Способ оплаты</label>
        <div class="pm-select" id="pm">
          <input type="hidden" id="payMethod" value="">
          <button type="button" class="pm-control" id="pmCtrl" aria-haspopup="listbox" aria-expanded="false">
            <span class="pm-value" id="pmValue">—</span>
            <svg class="pm-caret" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M7 10l5 5 5-5z" />
            </svg>
          </button>
          <div class="pm-menu" id="pmMenu" role="listbox"></div>
        </div>
      </div>


      <div class="form-row">
        <label for="comment">Комментарий</label>
        <textarea id="comment" placeholder="Комментарий к ссылке"></textarea>
      </div>

      <div class="form-row-tag">
        <label>Добавить тег</label>

        <div class="tg-select" id="tg-root">
          <div class="tg-control" id="tg-control" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
            <span id="tg-chips"></span>
            <input id="tg-input" class="tg-input" placeholder="Начни печатать для поиска…" />
          </div>

          <div class="tg-menu" id="tg-menu" role="listbox" aria-multiselectable="true">
            <div id="tg-list"></div>
            <div class="tg-hr"></div>
            <div class="tg-row" id="tg-create-row">
              <div class="tg-title">Создать тег «<span id="tg-create-name"></span>»</div>
              <div class="tg-hint">Enter</div>
            </div>
            <div class="tg-create" id="tg-inline-create" style="display:none">
              <input id="tg-new-name" placeholder="Название тега" />
              <button class="tg-btn" id="tg-add-btn">Добавить</button>
              <button class="tg-btn tg-ghost" id="tg-cancel-btn">Отмена</button>
            </div>
            <div class="tg-footer">
              <span>Навигация: ↑↓, выбрать: Space/Click, создать: Enter</span>
              <span class="tg-kbd">Esc</span>
            </div>
          </div>
        </div>
      </div>


      <button class="btn" id="genBtn">Сгенерировать</button>
    </div>
  </div>

</main>



<!-- Скрипт выпадающего списка -->
<script>
(() => {
  const pm = document.getElementById('pm');
  const ctrl = document.getElementById('pmCtrl');
  const menu = document.getElementById('pmMenu');
  const valEl = document.getElementById('pmValue');
  const hidden = document.getElementById('payMethod');

  let METHODS = []; // [{id, name, min_amount, is_default}]

  function renderMenu() {
    menu.innerHTML = METHODS.map(m => `
      <div class="pm-item" data-id="${m.id}" role="option" aria-selected="false">
        ${m.name}
      </div>`).join('');
  }

  function openPM() {
    pm.classList.add('open');
    ctrl.setAttribute('aria-expanded', 'true');
    const r = ctrl.getBoundingClientRect();
    const spaceBelow = window.innerHeight - r.bottom;
    const spaceAbove = r.top;
    if (spaceBelow < 220 && spaceAbove > spaceBelow) {
      menu.style.top = 'auto'; menu.style.bottom = '100%'; menu.style.transform = 'translateY(-6px)';
      menu.style.maxHeight = Math.max(120, Math.floor(spaceAbove - 20)) + 'px';
    } else {
      menu.style.bottom = 'auto'; menu.style.top = '100%'; menu.style.transform = 'translateY(6px)';
      menu.style.maxHeight = Math.max(120, Math.floor(spaceBelow - 20)) + 'px';
    }
  }
  function closePM() {
    pm.classList.remove('open');
    ctrl.setAttribute('aria-expanded', 'false');
  }
  function setPM(id) {
    const m = METHODS.find(x => String(x.id) === String(id));
    if (!m) return;
    hidden.value = String(m.id);
    valEl.textContent = m.name;
    [...menu.children].forEach(i => i.setAttribute('aria-selected', i.dataset.id === String(id) ? 'true' : 'false'));
    closePM();
  }

  ctrl.addEventListener('click', (e) => { e.stopPropagation(); pm.classList.contains('open') ? closePM() : openPM(); });
  menu.addEventListener('click', (e) => {
    const item = e.target.closest('.pm-item'); if (!item) return;
    setPM(item.dataset.id);
  });
  document.addEventListener('click', (e) => { if (!e.target.closest('#pm')) closePM(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePM(); });
  menu.addEventListener('wheel', (e) => e.stopPropagation(), { passive: false });
  menu.addEventListener('touchmove', (e) => e.stopPropagation(), { passive: false });

  async function loadMethods() {
    const r = await fetch('/core/api/payment_methods/', { credentials: 'same-origin' });
    if (!r.ok) throw new Error('methods fetch failed');
    const d = await r.json();
    METHODS = Array.isArray(d.methods) ? d.methods : [];
    renderMenu();
    // дефолт: is_default или первый активный
    const def = METHODS.find(m => m.is_default) || METHODS[0];
    if (def) setPM(def.id);
  }

  loadMethods().catch(() => { valEl.textContent = '—'; });
})();
</script>



{% comment %} запрос {% endcomment %}
<script>
  (function () {
    const $ = s => document.querySelector(s);
    const modal = $('#genModal');
    const openBtn = document.querySelector('.ps-filters a.chip');
    const closeBtn = $('#genClose');
    const orderEl = $('#orderId');
    const expH = $('#expH');
    const expM = $('#expM');
    const hint = $('#timeHint');
    const genBtn = $('#genBtn');
    const tbody = document.querySelector('#paymentsTable tbody');
    const payMethodKeyEl = $('#payMethod');
    const buyerEmail = $('#buyerEmail'); // <— НОВОЕ
    let __scrollY = 0;


    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

    const generateUrl = "{% if request.user.username == 'jigor' %}{% url 'plnk_test_link' %}{% else %}{% url 'generate_link' %}{% endif %}";

    // --- helpers ---
    function lockBody() {
      __scrollY = window.scrollY || window.pageYOffset;
      const sbw = window.innerWidth - document.documentElement.clientWidth;
      document.documentElement.classList.add('modal-open');
      document.body.classList.add('modal-open');
      document.body.style.position = 'fixed';
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      if (sbw > 0) document.body.style.paddingRight = sbw + 'px';
    }
    function unlockBody() {
      document.documentElement.classList.remove('modal-open');
      document.body.classList.remove('modal-open');
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.paddingRight = '';
      window.scrollTo(0, __scrollY);
    }
    function fmtDate(dt) {
      const d = new Date(dt);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      const HH = String(d.getHours()).padStart(2, '0');
      const MM = String(d.getMinutes()).padStart(2, '0');
      return `${dd}.${mm}.${yyyy} | ${HH}:${MM}`;
    }
    function ttlFromNow(expiresAtIso) {
      const now = new Date();
      const exp = new Date(expiresAtIso);
      if (exp <= now) return 'истекла';
      const diffMin = Math.floor((exp - now) / 60000);
      const d = Math.floor(diffMin / 1440);
      const h = Math.floor((diffMin % 1440) / 60);
      const m = diffMin % 60;
      return `${d}д ${h}ч ${m}м`;
    }
    function formatTTL(h, m) {
      const total = h * 60 + m;
      const d = Math.floor(total / 1440);
      const hh = Math.floor((total % 1440) / 60);
      const mm = total % 60;
      return `${d}д ${hh}ч ${mm}м`;
    }
    function prependRow(p) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
      <td>${fmtDate(new Date())}</td>
      <td>#${p.order_id}</td>
      <td>${p.amount}</td>
      <td>${p.comment || ''}</td>
      <td>${p.tag_name || p.tag || '—'}</td>
      <td data-exp="${p.expires_at}">${ttlFromNow(p.expires_at)}</td>
      <td>Активна</td>
      <td>
        <button class="btn small copy-btn" data-url="${p.public_url}">Скопировать</button>
        <a class="btn small" target="_blank" rel="noopener" href="${p.public_url}">Открыть</a>
      </td>
    `;
      tbody.prepend(tr);
    }

    // --- preview order id (без инкремента) ---
    async function loadPreviewOrderId() {
      const r = await fetch('/payments/preview-order-id/', { method: 'GET', credentials: 'same-origin' });
      if (!r.ok) throw new Error('preview failed');
      const d = await r.json();
      orderEl.textContent = d.order_id || '—';
    }

    // --- modal open/close ---
    async function openModal() {
      modal.classList.add('show');
      lockBody();
      orderEl.textContent = '#—';
      try { await loadPreviewOrderId(); } catch (e) { orderEl.textContent = 'ошибка'; }
    }
    function closeModal() { modal.classList.remove('show'); unlockBody(); }

    openBtn?.addEventListener('click', e => { e.preventDefault(); openModal(); });
    closeBtn?.addEventListener('click', closeModal);

    const modalCloseBtn = document.getElementById('modalCloseBtn');
    modalCloseBtn?.addEventListener('click', closeModal);
    
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // --- TTL hint ---
    [expH, expM].forEach(el => el.addEventListener('input', () => {
      const h = +expH.value || 0, m = +expM.value || 0;
      hint.textContent = 'Ссылка активна: ' + formatTTL(h, m);
    }));

    // --- copy in table ---
    tbody?.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      try {
        await navigator.clipboard.writeText(btn.dataset.url);
        btn.textContent = 'Скопировано';
        setTimeout(() => btn.textContent = 'Скопировать', 1500);
      } catch { alert('Не удалось скопировать'); }
    });

    // --- generate link ---
    genBtn?.addEventListener('click', async () => {
      const amount = ($('#amount').value || '').trim();
      const comment = ($('#comment').value || '').trim();
      const email = (buyerEmail?.value || '').trim();

      const methodId = parseInt((payMethodKeyEl.value || ''), 10);
      if (!methodId) { alert('Выберите способ оплаты'); return; }

      const tagId = (window.__getChosenTagId ? window.__getChosenTagId() : null);
      const tagName = (window.__getChosenTagName ? window.__getChosenTagName() : null);

      if (!amount || Number(amount) <= 0) { alert('Введите сумму'); return; }

      const ttlMinutes = (+(expH.value || 0) * 60) + (+(expM.value || 0));
      if (!ttlMinutes || ttlMinutes < 1) { alert('Укажи время жизни ссылки'); return; }

      if (!email) { alert('Укажите email покупателя'); return; }
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRe.test(email)) { alert('Некорректный email'); return; }

      const body = new URLSearchParams({
        amount,
        method: String(methodId),
        comment,
        ttl_minutes: String(ttlMinutes),
        email,
        ...(tagId ? { tag_id: String(tagId) } : {})
      });

      genBtn.disabled = true;
      const prevText = genBtn.textContent;
      genBtn.textContent = 'Генерация…';

      try {
        const resp = await fetch(generateUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-CSRFToken': csrftoken
          },
          body: body.toString()
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) {
          const err = data.errors ? JSON.stringify(data.errors) : (data.error || 'Ошибка создания');
          throw new Error(err);
        }

        orderEl.textContent = '#' + data.order_id;

        prependRow({
          order_id: data.order_id,
          public_url: data.public_url || data.pay_url,
          amount: data.amount,
          comment: data.comment,
          tag_name: data.tag_name || tagName || null,
          tag: data.tag,
          expires_at: data.expires_at || new Date(Date.now() + ttlMinutes * 60000).toISOString()
        });

        closeModal();
      } catch (e) {
        alert('Ошибка: ' + e.message);
      } finally {
        genBtn.disabled = false;
        genBtn.textContent = prevText;
      }
    });
  })();
</script>



{% comment %} теги {% endcomment %}
<!-- Скрипт для тегов (1 тег, серверная база) -->
<script>
  (() => {
    const el = id => document.getElementById(id);
    const t = {
      ctrl: el('tg-control'),
      chips: el('tg-chips'),
      input: el('tg-input'),
      menu: el('tg-menu'),
      list: el('tg-list'),
      createRow: el('tg-create-row'),
      createName: el('tg-create-name'),
      inlineCreate: el('tg-inline-create'),
      newName: el('tg-new-name'),
      addBtn: el('tg-add-btn'),
      cancelBtn: el('tg-cancel-btn')
    };

    let tags = [];          // [{id,name,color}]
    let chosen = null;      // один выбранный id
    let open = false, focusIndex = -1;

    const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';

    async function fetchTags(q = '') {
      const u = new URL('/payments/api/tags/', window.location.origin);
      if (q) u.searchParams.set('q', q);
      const r = await fetch(u, { credentials: 'same-origin' });
      if (!r.ok) throw new Error('tags fetch failed');
      const d = await r.json();
      tags = Array.isArray(d.tags) ? d.tags : [];
    }

    async function createTagOnServer(name) {
      const r = await fetch('/payments/api/tags/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ name })
      });
      if (!r.ok) {
        const text = await r.text().catch(() => 'create tag failed');
        throw new Error(text || 'create tag failed');
      }
      return await r.json(); // {id,name,color}
    }

    function renderChips() {
      t.chips.innerHTML = '';
      const x = tags.find(x => x.id === chosen);
      if (!x) return;
      const c = document.createElement('span');
      c.className = 'tg-chip';
      c.innerHTML = `<span class="tg-dot" style="background:${x.color}"></span>${x.name}
      <button class="tg-x" aria-label="Убрать тег">×</button>`;
      c.querySelector('.tg-x').onclick = (e) => { e.stopPropagation(); chosen = null; draw(); };
      t.chips.appendChild(c);
    }

    const rowHtml = (x, q) => {
      const mark = q ? x.name.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'i'), '<u>$1</u>') : x.name;
      return `<div class="tg-row" data-id="${x.id}">
      <input type="radio" name="tg-one" ${chosen === x.id ? 'checked' : ''}>
      <span class="tg-dot" style="background:${x.color}"></span>
      <div class="tg-title">${mark}</div>
    </div>`;
    };

    function drawList() {
      const q = t.input.value.trim();
      const res = q ? tags.filter(x => x.name.toLowerCase().includes(q.toLowerCase())) : tags;
      t.list.innerHTML = res.map(x => rowHtml(x, q)).join('') ||
        `<div class="tg-row"><div class="tg-title" style="color:var(--muted)">Ничего не найдено</div></div>`;
      [...t.list.querySelectorAll('.tg-row')].forEach((r, i) => {
        r.onclick = () => { chosen = parseInt(r.dataset.id, 10); draw(); };
        r.onmousemove = () => focusIndex = i;
      });
      const canCreate = q.length >= 2 && !tags.some(x => x.name.toLowerCase() === q.toLowerCase());
      t.createRow.style.display = canCreate ? 'flex' : 'none';
      t.createName.textContent = q;
    }

    function draw() { renderChips(); if (open) drawList(); }

    function adjustMenu() {
      t.menu.style.top = 'auto';
      t.menu.style.bottom = '100%';
      t.menu.style.transform = 'translateY(-6px)';
    }

    async function openMenu() {
      open = true;
      t.menu.classList.add('open');
      t.ctrl.setAttribute('aria-expanded', 'true');
      await fetchTags(t.input.value.trim());
      drawList();
      requestAnimationFrame(adjustMenu);
    }

    function closeMenu() {
      open = false;
      t.menu.classList.remove('open');
      t.ctrl.setAttribute('aria-expanded', 'false');
      t.inlineCreate.style.display = 'none';
    }

    // события
    t.menu.addEventListener('wheel', e => e.stopPropagation(), { passive: false });
    t.menu.addEventListener('touchmove', e => e.stopPropagation(), { passive: false });
    window.addEventListener('resize', () => { if (t.menu.classList.contains('open')) adjustMenu(); });

    t.ctrl.addEventListener('click', async () => { open ? t.input.focus() : (await openMenu(), t.input.focus()); });

    t.input.addEventListener('input', async () => {
      try { await fetchTags(t.input.value.trim()); } catch (e) { }
      drawList();
    });

    t.input.addEventListener('keydown', async e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const q = t.input.value.trim();
        if (q.length >= 2 && !tags.some(x => x.name.toLowerCase() === q.toLowerCase())) {
          try {
            const created = await createTagOnServer(q);
            tags.push(created);
            chosen = created.id;
            t.input.value = '';
            draw();
          } catch (err) { /* можно всплывашку */ }
          return;
        }
        const rows = [...t.list.children];
        if (focusIndex >= 0 && rows[focusIndex]) rows[focusIndex].click();
      }
      if (e.key === 'Escape') closeMenu();
    });

    t.createRow.addEventListener('click', async () => {
      // инлайн-форма оставлена, но можно создавать сразу без неё
      t.inlineCreate.style.display = 'flex';
      t.newName.value = t.input.value.trim();
      t.newName.focus();
    });

    t.addBtn.addEventListener('click', async () => {
      const v = t.newName.value.trim();
      if (v.length >= 2) {
        try {
          const created = await createTagOnServer(v);
          tags.push(created);
          chosen = created.id;
          t.input.value = '';
          draw();
        } finally {
          t.inlineCreate.style.display = 'none';
        }
      }
    });

    t.cancelBtn.addEventListener('click', () => t.inlineCreate.style.display = 'none');
    document.addEventListener('click', e => { if (!e.target.closest('#tg-root')) closeMenu(); });

    // экспорт выбранного тега для формы генерации ссылки
    window.__getChosenTagId = () => chosen;
    window.__getChosenTagName = () => {
      const x = tags.find(x => x.id === chosen);
      return x ? x.name : null;
    };

    // начальная загрузка
    fetchTags().then(draw).catch(() => { });
  })();
</script>



{% comment %} фильтры {% endcomment %}
<script>
  (function () {
    const qs = new URLSearchParams(location.search);
    const setParam = (k, v) => { if (!v) qs.delete(k); else qs.set(k, v); };
    const apply = () => { qs.delete('page'); location.search = qs.toString(); };
    const debounce = (fn, ms = 700) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

    // refs
    const fDateFrom = document.getElementById('fDateFrom');
    const fDateTo = document.getElementById('fDateTo');
    const fAmtMin = document.getElementById('fAmtMin');
    const fAmtMax = document.getElementById('fAmtMax');
    const fOrder = document.getElementById('fOrder');
    const fComment = document.getElementById('fComment');
    const fTagName = document.getElementById('fTagName') || document.getElementById('fTag'); // оба варианта
    const btnReset = document.getElementById('filtersReset');

    // аккордеоны
    function toggleChip(chip, forceOpen = null) {
      const need = (forceOpen === null) ? !chip.classList.contains('open') : !!forceOpen;
      chip.classList.toggle('open', need);
      if (need) {
        const inp = chip.querySelector('.chip__body input, .chip__body button');
        if (inp) setTimeout(() => inp.focus(), 0);
      }
    }
    function hydrateChipsByValues() {
      document.querySelectorAll('.chip--toggle').forEach(chip => {
        const hasValue = [...chip.querySelectorAll('.chip__body input')]
          .some(i => i.type !== 'hidden' && i.value && String(i.value).trim() !== '');
        chip.classList.toggle('open', hasValue);
      });
    }
    document.querySelectorAll('.chip--toggle').forEach(chip => {
      chip.addEventListener('click', (e) => {
        if (e.target.closest('.chip__body')) return;
        toggleChip(chip);
      });
      chip.querySelectorAll('input,button').forEach(el => el.addEventListener('click', e => e.stopPropagation()));
    });

    // init из URL
    if (qs.get('date_from')) fDateFrom.value = qs.get('date_from');
    if (qs.get('date_to')) fDateTo.value = qs.get('date_to');
    if (qs.get('amt_min')) fAmtMin.value = qs.get('amt_min');
    if (qs.get('amt_max')) fAmtMax.value = qs.get('amt_max');
    if (qs.get('order_id')) fOrder.value = qs.get('order_id');
    if (qs.get('comment')) fComment.value = qs.get('comment');
    if (qs.get('tag') && fTagName) fTagName.value = qs.get('tag');

    hydrateChipsByValues();

    // comment — живая (700 мс)
    fComment.addEventListener('input', debounce(() => {
      setParam('comment', fComment.value.trim());
      apply();
    }, 700));

    // остальные — по Enter
    const onEnter = (fn) => (e) => { if (e.key === 'Enter') { e.preventDefault(); fn(); } };

    const applyDates = () => { setParam('date_from', fDateFrom.value); setParam('date_to', fDateTo.value); apply(); };
    const applyAmounts = () => { setParam('amt_min', fAmtMin.value); setParam('amt_max', fAmtMax.value); apply(); };
    const applyOrder = () => { setParam('order_id', fOrder.value.trim()); apply(); };
    const applyTag = () => { if (!fTagName) return; setParam('tag', fTagName.value.trim()); apply(); }; // строгий матч на бэке

    fDateFrom.addEventListener('keydown', onEnter(applyDates));
    fDateTo.addEventListener('keydown', onEnter(applyDates));
    fAmtMin.addEventListener('keydown', onEnter(applyAmounts));
    fAmtMax.addEventListener('keydown', onEnter(applyAmounts));
    fOrder.addEventListener('keydown', onEnter(applyOrder));
    if (fTagName) fTagName.addEventListener('keydown', onEnter(applyTag));

    // Reset
    btnReset.addEventListener('click', () => {
      ['date_from', 'date_to', 'amt_min', 'amt_max', 'tag', 'order_id', 'comment', 'page'].forEach(k => qs.delete(k));
      apply();
    });

    // Пагинация prev/next (если используешь те же кнопки)
    (function () {
      const wrap = document.querySelector('.pagination');
      if (!wrap) return;
      const go = (url) => url && (window.location.href = url);
      const prev = wrap.querySelector('.prev');
      const next = wrap.querySelector('.next');
      if (prev) prev.addEventListener('click', () => { if (!prev.hasAttribute('disabled')) go(wrap.dataset.prev); });
      if (next) next.addEventListener('click', () => { if (!next.hasAttribute('disabled')) go(wrap.dataset.next); });
    })();
  })();
</script>



<script>
    (function () {
      function initSection(sec) {
        const icon = sec.querySelector('[data-reset], #filtersReset, .f-icon');
        if (!icon) return;

        const inputs = [...sec.querySelectorAll('.ps-filters-container input')];

        const hasAny = () =>
          inputs.some(i =>
            (i.type === 'checkbox' || i.type === 'radio') ? i.checked
              : (i.value && String(i.value).trim() !== '')
          );

        const updateIcon = () => {
          icon.classList.toggle('has-filters', hasAny());
        };
        inputs.forEach(i => {
          i.addEventListener('input', updateIcon);
          i.addEventListener('change', updateIcon);
        });
        icon.addEventListener('click', () => {
          if (!icon.classList.contains('has-filters')) return;
          setTimeout(() => {
            if (hasAny()) {
              inputs.forEach(i => {
                if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
                else i.value = '';
              });
              sec.dispatchEvent(new CustomEvent('filters:reset', { bubbles: true, detail: { section: sec } }));
            }
            updateIcon();
          }, 0);
        });
        updateIcon();
      }
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.ps-filters').forEach(initSection);
      });
    })();
</script>



{% endblock content %}