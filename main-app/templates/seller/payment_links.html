{% extends '_base.html' %}
{% load static %}
{% load pay_extras %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/base_lk.css'%}">
<link rel="stylesheet" href="{% static 'css/pages/payment-status.css'%}">
<link rel="stylesheet" href="{% static 'css/pages/payment-links.css'%}">
{% endblock styles %}

{% block content %}


<div class="sub-nav-lk-container">
    <div class="sub-nav-lk">
        <a href="{% url 'brief-stats' %}">Краткая статистика</a>
        <a href="{% url 'payment-status' %}">Статус платежей</a>
        <a href="">Выводы</a>
        <a href="">Генерация отчета</a>
        <a href="">Уведомления</a>
        <a href="{% url 'payment-links' %}">Платежные ссылки</a>
        <a href="">История чарж-беков</a>
    </div>
</div>

<main>



    <section class="ps-filters">

        <div class="ps-filters-container">
            <button class="f-icon" id="filtersReset" aria-label="Сбросить фильтры" title="Сбросить фильтры">
                <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M3 5h18l-6.5 7.5v5.75l-5 2.5V12.5L3 5z" />
                </svg>
            </button>

            <label class="chip chip--toggle" data-chip="date">
                <span class="chip__title">Дата</span>
                <span class="chip__body">
                    <input type="date" id="fDateFrom" placeholder="с">
                    <input type="date" id="fDateTo" placeholder="по">
                </span>
            </label>

            <!-- Сумма -->
            <label class="chip chip--toggle" data-chip="amount">
                <span class="chip__title">Сумма платежа</span>
                <span class="chip__body">
                    <input type="number" id="fAmtMin" inputmode="numeric" placeholder="от">
                    <input type="number" id="fAmtMax" inputmode="numeric" placeholder="до">
                </span>
            </label>

            <!-- Tag -->
            <label class="chip chip--toggle" data-chip="tag">
                <span class="chip__title">Tag</span>
                <span class="chip__body">
                    <input type="text" id="fTag" placeholder="например: promo">
                </span>
            </label>

            <label class="chip grow">
                <input type="text" id="fOrder" placeholder="Точечный поиск по: Order ID">
            </label>

            <label class="chip grow">
                <input type="text" id="fComment" placeholder="Поиск по: Комментарию">
            </label>
        </div>


        <a href="" class="chip">Добавить ссылку</a>


    </section>




    <section class="ps-wrap">
        <div class="ps-scroll">
            <table class="ps-table" id="paymentsTable">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Order ID</th>
                        <th>Сумма платежа&nbsp;<small>(₽)</small></th>
                        <th>Комментарий</th>
                        <th>Tag</th>
                        <th>Срок ссылки</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in payments %}
                    <tr>
                        <td>{{ p.created_at|date:"d.m.Y | H:i" }}</td>
                        <td>#{{ p.order_id }}</td>
                        <td>{{ p.amount }}</td>
                        <td>{{ p.comment|default:"" }}</td>
                        <td>{{ p.tag|default:"—" }}</td>
                        <td>{{ p.expires_at|ttl }}</td>
                        <td>
                        {% if p.status == "pending" %}Активна{% else %}{{ p.status }}{% endif %}
                        </td>
                        <td>
                        <button class="btn small copy-btn" data-url="{{ p.public_url }}">Скопировать</button>
                        <a class="btn small" target="_blank" rel="noopener" href="{{ p.public_url }}">Открыть</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" style="text-align:center;color:var(--muted)">Активных ссылок нет</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>




    <div class="pagination">
        <button class="page-btn prev" aria-label="Предыдущая">
            <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
                    fill="white" />
            </svg>
        </button>

        <a href="#" class="page-num">1</a>
        <a href="#" class="page-num active">2</a>
        <a href="#" class="page-num">3</a>

        <button class="page-btn next" aria-label="Следующая">
            <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg"
                style="transform: rotate(180deg);">
                <path
                    d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
                    fill="white" />
            </svg>
        </button>
    </div>




    <!-- Модалка генерации -->
    <div class="modal" id="genModal" aria-hidden="true">
        <div class="modal__bg" id="genClose"></div>
        <div class="modal__box">
            <h2>Генерация ссылки</h2>

            <div class="form-row">
                <div class="order-id-container">
                    <label class="order-label">Order ID:</label>
                    <div class="order-id" id="orderId">-</div>
                </div>

                <input type="hidden" name="order_id" id="order_id">
                <input type="hidden" name="order_seq" id="order_seq">
                <input type="hidden" name="order_prefix" id="order_prefix">
                <input type="hidden" name="order_date" id="order_date">

                <p class="hint">Запиши этот ID — он нужен для отслеживания платежа.</p>
            </div>

            <div class="form-row">
                <label for="amount">Сумма заказа (₽)</label>
                <input type="number" id="amount" placeholder="Введите сумму">
            </div>

            <div class="form-row">
                <label>Время жизни ссылки</label>
                <div class="inline">
                    <input type="number" id="expH" min="0" placeholder="часы">
                    <input type="number" id="expM" min="0" placeholder="минуты">
                </div>
                <p class="hint" id="timeHint">Ссылка активна: 0д 0ч 0м</p>
            </div>

            <div class="form-row">
                <label for="payMethod">Способ оплаты</label>
                <div class="pm-select" id="pm">
                    <input type="hidden" id="payMethod" value="sbp">
                    <button type="button" class="pm-control" id="pmCtrl" aria-haspopup="listbox" aria-expanded="false">
                        <span class="pm-value" id="pmValue">СБП</span>
                        <svg class="pm-caret" width="12" height="12" viewBox="0 0 24 24" aria-hidden="true">
                            <path fill="currentColor" d="M7 10l5 5 5-5z" />
                        </svg>
                    </button>
                    <div class="pm-menu" id="pmMenu" role="listbox">
                        <div class="pm-item" data-value="sbp" aria-selected="true">СБП</div>
                        <div class="pm-item" data-value="card">Карта</div>
                        <div class="pm-item" data-value="sberpay">СберПэй</div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="comment">Комментарий</label>
                <textarea id="comment" placeholder="Комментарий к ссылке"></textarea>
            </div>

            <div class="form-row-tag">
                <label>Добавить тег</label>

                <div class="tg-select" id="tg-root">
                    <div class="tg-control" id="tg-control" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                        <span id="tg-chips"></span>
                        <input id="tg-input" class="tg-input" placeholder="Начни печатать для поиска…" />
                    </div>

                    <div class="tg-menu" id="tg-menu" role="listbox" aria-multiselectable="true">
                        <div id="tg-list"></div>
                        <div class="tg-hr"></div>
                        <div class="tg-row" id="tg-create-row">
                            <div class="tg-title">Создать тег «<span id="tg-create-name"></span>»</div>
                            <div class="tg-hint">Enter</div>
                        </div>
                        <div class="tg-create" id="tg-inline-create" style="display:none">
                            <input id="tg-new-name" placeholder="Название тега" />
                            <button class="tg-btn" id="tg-add-btn">Добавить</button>
                            <button class="tg-btn tg-ghost" id="tg-cancel-btn">Отмена</button>
                        </div>
                        <div class="tg-footer">
                            <span>Навигация: ↑↓, выбрать: Space/Click, создать: Enter</span>
                            <span class="tg-kbd">Esc</span>
                        </div>
                    </div>
                </div>
            </div>


            <button class="btn" id="genBtn">Сгенерировать</button>
        </div>
    </div>

</main>



<!-- Скрипт выпадающего списка -->
<script>
    (() => {
        const pm = document.getElementById('pm');
        const ctrl = document.getElementById('pmCtrl');
        const menu = document.getElementById('pmMenu');
        const valEl = document.getElementById('pmValue');
        const hidden = document.getElementById('payMethod');

        function openPM() {
            pm.classList.add('open');
            ctrl.setAttribute('aria-expanded', 'true');
            // авто-позиция: если снизу мало места — откроем вверх
            const r = ctrl.getBoundingClientRect();
            const spaceBelow = window.innerHeight - r.bottom;
            const spaceAbove = r.top;
            if (spaceBelow < 220 && spaceAbove > spaceBelow) {
                menu.style.top = 'auto'; menu.style.bottom = '100%'; menu.style.transform = 'translateY(-6px)';
                menu.style.maxHeight = Math.max(120, Math.floor(spaceAbove - 20)) + 'px';
            } else {
                menu.style.bottom = 'auto'; menu.style.top = '100%'; menu.style.transform = 'translateY(6px)';
                menu.style.maxHeight = Math.max(120, Math.floor(spaceBelow - 20)) + 'px';
            }
        }
        function closePM() {
            pm.classList.remove('open');
            ctrl.setAttribute('aria-expanded', 'false');
        }
        function setPM(value, text) {
            hidden.value = value;
            valEl.textContent = text;
            [...menu.children].forEach(i => i.setAttribute('aria-selected', i.dataset.value === value ? 'true' : 'false'));
            closePM();
        }

        ctrl.addEventListener('click', (e) => { e.stopPropagation(); pm.classList.contains('open') ? closePM() : openPM(); });
        menu.addEventListener('click', (e) => {
            const item = e.target.closest('.pm-item'); if (!item) return;
            setPM(item.dataset.value, item.textContent.trim());
        });
        document.addEventListener('click', (e) => { if (!e.target.closest('#pm')) closePM(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePM(); });

        // колесо/свайп не отдаём за пределы
        menu.addEventListener('wheel', (e) => e.stopPropagation(), { passive: false });
        menu.addEventListener('touchmove', (e) => e.stopPropagation(), { passive: false });

        // дефолт: СБП
        setPM('sbp', 'СБП');
    })();
</script>





<script>
(function () {
  const $ = s => document.querySelector(s);
  const modal = $('#genModal');
  const openBtn = document.querySelector('.ps-filters a.chip');
  const closeBtn = $('#genClose');
  const orderEl = $('#orderId');
  const expH = $('#expH');
  const expM = $('#expM');
  const hint = $('#timeHint');
  const genBtn = $('#genBtn');
  const tbody = document.querySelector('#paymentsTable tbody');
  const payMethodKeyEl = $('#payMethod');
  let __scrollY = 0;

  const METHOD_MAP = { sbp: 44, card: 36, sberpay: 35 };

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // --- РЕЗЕРВ ORDER_ID ---
  let allocated = null;

  async function allocateOrderId() {
    const r = await fetch('/payments/allocate-order-id/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    });
    if (!r.ok) throw new Error('allocate failed');
    const d = await r.json();
    allocated = d;
    orderEl.textContent = d.order_id || '—';
  }

  function lockBody() {
    __scrollY = window.scrollY || window.pageYOffset;
    const sbw = window.innerWidth - document.documentElement.clientWidth;
    document.documentElement.classList.add('modal-open');
    document.body.classList.add('modal-open');
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__scrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    if (sbw > 0) document.body.style.paddingRight = sbw + 'px';
  }
  function unlockBody() {
    document.documentElement.classList.remove('modal-open');
    document.body.classList.remove('modal-open');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.paddingRight = '';
    window.scrollTo(0, __scrollY);
  }

  async function openModal() {
    modal.classList.add('show');
    lockBody();
    orderEl.textContent = '#—';
    try { await allocateOrderId(); } catch(e) { orderEl.textContent = 'ошибка'; }
  }
  function closeModal() { modal.classList.remove('show'); unlockBody(); /* allocated не сбрасываем */ }

  openBtn.addEventListener('click', e => { e.preventDefault(); openModal(); });
  closeBtn.addEventListener('click', closeModal);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  function formatTTL(h, m) {
    const total = h * 60 + m;
    const d = Math.floor(total / 1440);
    const hh = Math.floor((total % 1440) / 60);
    const mm = total % 60;
    return `${d}д ${hh}ч ${mm}м`;
  }
  [expH, expM].forEach(el => el.addEventListener('input', () => {
    const h = +expH.value || 0, m = +expM.value || 0;
    hint.textContent = 'Ссылка активна: ' + formatTTL(h, m);
  }));

  function fmtDate(dt) {
    const d = new Date(dt);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const HH = String(d.getHours()).padStart(2,'0');
    const MM = String(d.getMinutes()).padStart(2,'0');
    return `${dd}.${mm}.${yyyy} | ${HH}:${MM}`;
  }
  function ttlFromNow(expiresAtIso) {
    const now = new Date();
    const exp = new Date(expiresAtIso);
    if (exp <= now) return 'истекла';
    const diffMin = Math.floor((exp - now) / 60000);
    const d = Math.floor(diffMin / 1440);
    const h = Math.floor((diffMin % 1440) / 60);
    const m = diffMin % 60;
    return `${d}д ${h}ч ${m}м`;
  }

  function prependRow(p) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(new Date())}</td>
      <td>#${p.order_id}</td>
      <td>${p.amount}</td>
      <td>${p.comment || ''}</td>
      <td>${p.tag || '—'}</td>
      <td data-exp="${p.expires_at}">${ttlFromNow(p.expires_at)}</td>
      <td>pending</td>
      <td>
        <button class="btn small copy-btn" data-url="${p.public_url}">Скопировать</button>
        <a class="btn small" target="_blank" rel="noopener" href="${p.public_url}">Открыть</a>
      </td>
    `;
    tbody.prepend(tr);
  }

  tbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('.copy-btn');
    if (!btn) return;
    try {
      await navigator.clipboard.writeText(btn.dataset.url);
      btn.textContent = 'Скопировано';
      setTimeout(() => btn.textContent = 'Скопировать', 1500);
    } catch {
      alert('Не удалось скопировать');
    }
  });

  genBtn.addEventListener('click', async () => {
    const amount = ($('#amount').value || '').trim();
    const comment = ($('#comment').value || '').trim();
    const tag = ($('#tg-input').value || '').trim();
    const methodKey = ($('#payMethod').value || 'sbp').toLowerCase();
    const method = METHOD_MAP[methodKey] || 44;

    if (!amount || Number(amount) <= 0) { alert('Введите сумму'); return; }
    if (!allocated?.order_id) {
      try { await allocateOrderId(); } catch(e){ return alert('Не удалось получить Order ID'); }
    }

    const body = new URLSearchParams({
      amount, method, comment, tag,
      order_id: allocated.order_id,
      order_seq: allocated.order_seq ?? '',
      order_prefix: allocated.order_prefix ?? '',
      order_date: allocated.order_date ?? ''
    });

    try {
      const resp = await fetch("{% url 'generate_link' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-CSRFToken': csrftoken
        },
        body: body.toString()
      });
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        const err = data.errors ? JSON.stringify(data.errors) : (data.error || 'Ошибка создания');
        throw new Error(err);
      }

      orderEl.textContent = '#' + data.order_id;
      prependRow({
        order_id: data.order_id,
        public_url: data.public_url || data.pay_url,
        amount: data.amount,
        comment: data.comment,
        tag: data.tag,
        expires_at: data.expires_at || new Date(Date.now() + 24*3600*1000).toISOString()
      });

      window.open(data.public_url || data.pay_url, '_blank');
      closeModal();

    } catch (e) {
      alert('Ошибка: ' + e.message);
    }
  });
})();
</script>





<!-- Скрипт для тегов -->
<script>
    (() => {
        const el = id => document.getElementById(id);
        const t = {
            ctrl: el('tg-control'),
            chips: el('tg-chips'),
            input: el('tg-input'),
            menu: el('tg-menu'),
            list: el('tg-list'),
            createRow: el('tg-create-row'),
            createName: el('tg-create-name'),
            inlineCreate: el('tg-inline-create'),
            newName: el('tg-new-name'),
            addBtn: el('tg-add-btn'),
            cancelBtn: el('tg-cancel-btn')
        };

        const key = 'tags_v2';
        const saved = JSON.parse(localStorage.getItem(key) || '{}');
        let tags = saved.tags || [
            { id: 'design', name: 'Design', color: '#22d3ee' },
            { id: 'backend', name: 'Backend', color: '#a855f7' },
            { id: 'frontend', name: 'Frontend', color: '#8b5cf6' },
            { id: 'urgent', name: 'Urgent', color: '#ef4444' },
            { id: 'low', name: 'Low Priority', color: '#10b981' },
            { id: 'research', name: 'Research', color: '#f59e0b' }
        ];
        let chosen = new Set(saved.chosen || []);
        let open = false, focusIndex = -1;

        const save = () => localStorage.setItem(key, JSON.stringify({ tags, chosen: [...chosen] }));
        const randColor = () => ['#a855f7', '#22d3ee', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#eab308'][Math.floor(Math.random() * 8)];
        const slug = s => s.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');

        const renderChips = () => {
            t.chips.innerHTML = '';
            const arr = tags.filter(x => chosen.has(x.id));
            arr.slice(0, 3).forEach(x => {
                const c = document.createElement('span');
                c.className = 'tg-chip';
                c.innerHTML = `<span class="tg-dot" style="background:${x.color}"></span>${x.name}
                    <button class="tg-x">×</button>`;
                c.querySelector('.tg-x').onclick = (e) => { e.stopPropagation(); chosen.delete(x.id); save(); draw(); };
                t.chips.appendChild(c);
            });
            if (arr.length > 3) {
                const m = document.createElement('span');
                m.className = 'tg-more';
                m.textContent = `+${arr.length - 3}`;
                t.chips.appendChild(m);
            }
        };

        const rowHtml = (x, q) => {
            const mark = q ? x.name.replace(new RegExp(`(${q})`, 'i'), '<u>$1</u>') : x.name;
            return `<div class="tg-row" data-id="${x.id}">
                <input type="checkbox" ${chosen.has(x.id) ? 'checked' : ''}>
                <span class="tg-dot" style="background:${x.color}"></span>
                <div class="tg-title">${mark}</div>
                </div>`;
        };

        const drawList = () => {
            const q = t.input.value.trim();
            const res = q ? tags.filter(x => x.name.toLowerCase().includes(q.toLowerCase())) : tags;
            t.list.innerHTML = res.map(x => rowHtml(x, q)).join('') ||
                `<div class="tg-row"><div class="tg-title" style="color:var(--muted)">Ничего не найдено</div></div>`;
            [...t.list.querySelectorAll('.tg-row')].forEach((r, i) => { r.onclick = () => toggle(r.dataset.id); r.onmousemove = () => focusIndex = i; });
            const canCreate = q.length >= 2 && !tags.some(x => x.name.toLowerCase() === q.toLowerCase());
            t.createRow.style.display = canCreate ? 'flex' : 'none';
            t.createName.textContent = q;
        };

        const draw = () => { renderChips(); if (open) drawList(); };
        const toggle = id => { chosen.has(id) ? chosen.delete(id) : chosen.add(id); save(); draw(); };
        const createTag = name => {
            const id = slug(name) || ('tag-' + Math.random().toString(36).slice(2, 7));
            if (tags.some(x => x.id === id) || tags.some(x => x.name.toLowerCase() === name.toLowerCase())) return;
            const color = randColor();
            tags.push({ id, name, color });
            chosen.add(id);
            save(); t.input.value = ''; draw();
        };

        const openMenu = () => {
            open = true;
            t.menu.classList.add('open');
            t.ctrl.setAttribute('aria-expanded', 'true');
            drawList();
            requestAnimationFrame(adjustMenu);
        };
        const closeMenu = () => { open = false; t.menu.classList.remove('open'); t.ctrl.setAttribute('aria-expanded', 'false'); t.inlineCreate.style.display = 'none'; };

        // === добавить где-нибудь рядом с объявлениями функций ===
        function adjustMenu() {
            // всегда открыть вверх
            t.menu.style.top = 'auto';
            t.menu.style.bottom = '100%';
            t.menu.style.transform = 'translateY(-6px)';
            // ограничим высоту и дадим скролл
            const spaceAbove = t.ctrl.getBoundingClientRect().top;
            // t.menu.style.maxHeight = Math.max(120, Math.floor(spaceAbove - 20)) + 'px';
        }


        // не отдаём прокрутку наружу
        t.menu.addEventListener('wheel', e => e.stopPropagation(), { passive: false });
        t.menu.addEventListener('touchmove', e => e.stopPropagation(), { passive: false });

        // пересчёт при ресайзе, если меню открыто
        window.addEventListener('resize', () => {
            if (t.menu.classList.contains('open')) adjustMenu();
        });


        t.ctrl.addEventListener('click', () => { open ? t.input.focus() : (openMenu(), t.input.focus()); });
        t.input.addEventListener('input', drawList);
        t.input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const q = t.input.value.trim();
                const exact = q && tags.some(x => x.name.toLowerCase() === q.toLowerCase());
                if (q && !exact) { createTag(q); return; }
                const rows = [...t.list.children];
                if (focusIndex >= 0 && rows[focusIndex]) rows[focusIndex].click();
            }
            if (e.key === 'Escape') { closeMenu(); }
        });

        t.createRow.addEventListener('click', () => { t.inlineCreate.style.display = 'flex'; t.newName.value = t.input.value.trim(); t.newName.focus(); });
        t.addBtn.addEventListener('click', () => { const v = t.newName.value.trim(); if (v.length >= 2) { createTag(v); t.inlineCreate.style.display = 'none'; } });
        t.cancelBtn.addEventListener('click', () => t.inlineCreate.style.display = 'none');
        document.addEventListener('click', e => { if (!e.target.closest('#tg-root')) closeMenu(); });
        draw();
    })();
</script>




{% endblock content %}