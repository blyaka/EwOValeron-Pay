{% extends '_base.html' %}
{% load static %}


{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/base_lk.css'%}">
<link rel="stylesheet" href="{% static 'css/pages/payment-status.css'%}">
{% endblock styles %}

{% block content %}


<div class="sub-nav-lk-container">
    <div class="sub-nav-lk">
        <a href="">Краткая статистика</a>
        <a href="{% url 'payment-status' %}">Статус платежей</a>
        <a href="">Выводы</a>
        <a href="">Генерация отчета</a>
        <a href="">Уведомления</a>
        <a href="{% url 'payment-links' %}">Генерация платежных ссылок</a>
        <a href="">История чарж-беков</a>
    </div>
</div>


<main>

    <section class="ps-filters">
        <button class="f-icon" id="filtersReset" aria-label="Сбросить фильтры" title="Сбросить фильтры">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M3 5h18l-6.5 7.5v5.75l-5 2.5V12.5L3 5z" />
            </svg>
        </button>

        <label class="chip chip--toggle" data-chip="date">
            <span class="chip__title">Дата</span>
            <span class="chip__body">
                <input type="date" id="fDateFrom" placeholder="с">
                <input type="date" id="fDateTo" placeholder="по">
            </span>
        </label>

        <!-- Сумма -->
        <label class="chip chip--toggle" data-chip="amount">
            <span class="chip__title">Сумма платежа</span>
            <span class="chip__body">
                <input type="number" id="fAmtMin" inputmode="numeric" placeholder="от">
                <input type="number" id="fAmtMax" inputmode="numeric" placeholder="до">
            </span>
        </label>

        <!-- Tag -->
        <label class="chip chip--toggle" data-chip="tag">
            <span class="chip__title">Tag</span>
            <span class="chip__body">
                <input type="text" id="fTag" placeholder="например: promo">
            </span>
        </label>

        <label class="chip grow">
            <input type="text" id="fOrder" placeholder="Точечный поиск по: Order ID">
        </label>

        <label class="chip grow">
            <input type="text" id="fComment" placeholder="Поиск по: Комментарию">
        </label>
    </section>


    <section class="ps-wrap">
        <div class="ps-scroll">
            <table class="ps-table" id="paymentsTable">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Order ID</th>
                        <th>Комментарий</th>
                        <th>Сумма платежа<br><small>(₽)</small></th>
                        <th>Комиссия [7,5%]<br><small>(₽)</small></th>
                        <th>К выплате<br><small>(₽)</small></th>
                        <th>Метод</th>
                        <th>Статус</th>
                        <th>intid</th>
                        <th>tag</th>
                        <th>Продавец</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- сюда закинет JS -->
                </tbody>
            </table>
        </div>
    </section>

    <div class="pagination">
        <button class="page-btn prev" aria-label="Предыдущая">
            <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
                    fill="white" />
            </svg>
        </button>

        <a href="#" class="page-num">1</a>
        <a href="#" class="page-num active">2</a>
        <a href="#" class="page-num">3</a>

        <button class="page-btn next" aria-label="Следующая">
            <svg width="7" height="13" viewBox="0 0 7 13" xmlns="http://www.w3.org/2000/svg"
                style="transform: rotate(180deg);">
                <path
                    d="M0.16532 6.90499L6.10553 12.8455C6.20465 12.9447 6.33633 13 6.47326 13C6.6102 13 6.74188 12.9447 6.841 12.8455L6.84739 12.8388C6.89561 12.7907 6.934 12.7329 6.96024 12.6687C6.98647 12.6046 7 12.5355 7 12.4657C7 12.3959 6.98647 12.3268 6.96024 12.2627C6.934 12.1985 6.89561 12.1407 6.84739 12.0926L1.25359 6.49888L6.84739 0.907408C6.89561 0.859332 6.934 0.801463 6.96024 0.737323C6.98647 0.673182 7 0.604109 7 0.534307C7 0.464505 6.98647 0.395434 6.96024 0.331293C6.934 0.267152 6.89561 0.209283 6.84739 0.161207L6.841 0.154494C6.74188 0.0553237 6.6102 0 6.47326 0C6.33633 0 6.20465 0.0553237 6.10553 0.154494L0.16532 6.09502C0.113078 6.14726 0.0714882 6.21009 0.0430707 6.2797C0.0146533 6.34932 0 6.42427 0 6.5C0 6.57574 0.0146533 6.65068 0.0430707 6.7203C0.0714882 6.78991 0.113078 6.85274 0.16532 6.90499Z"
                    fill="white" />
            </svg>
        </button>
    </div>

    <script>
        // ===== Demo-данные
        const row = {
            date: "22.09.2025 | 13:41",
            order: "#20252409-32",
            comment: "Пакет 1000 кристаллов (@ivan)",
            amount: 1000,
            fee: 75,
            payout: 925,
            method: "СБП",
            status: "ok",
            intid: "73638261",
            tag: "promo",
            seller: "nick"
        };
        const paymentsSrc = Array.from({ length: 15 }, (_, i) => ({
            ...row,
            order: `#2025${2409 + i}-${30 + (i % 60)}`,
            amount: 500 + (i % 9) * 250,
            payout: 500 + (i % 9) * 250 - 75,
            date: `${String(10 + (i % 20)).padStart(2, "0")}.09.2025 | ${String(10 + (i % 10)).padStart(2, "0")}:${String(11 + (i % 47)).padStart(2, "0")}`,
            tag: i % 3 ? "promo" : "нет",
        }));

        const tbody = document.querySelector("#paymentsTable tbody");
        const $ = (id) => document.getElementById(id);

        // ===== helpers
        function parseRuDate(s) {
            // "22.09.2025 | 13:41" -> Date
            const [dpart, tpart] = s.split("|").map(x => x.trim());
            const [dd, mm, yyyy] = dpart.split(".").map(Number);
            const [HH, MM] = (tpart || "00:00").split(":").map(Number);
            return new Date(yyyy, mm - 1, dd, HH, MM, 0, 0);
        }
        function hasVal(v) { return v !== undefined && v !== null && String(v).trim() !== ""; }

        // ===== рендер
        function render(rows) {
            tbody.innerHTML = "";
            rows.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${p.date}</td>
        <td><span class="ps-link">${p.order}</span></td>
        <td class="clip" title="${p.comment}">${p.comment}</td>
        <td class="num">${p.amount}</td>
        <td class="num">${p.fee}</td>
        <td class="num">${p.payout}</td>
        <td>${p.method}</td>
        <td class="status"><span class="chk ok" aria-label="ok"></span></td>
        <td class="mono">${p.intid}</td>
        <td class="muted">${p.tag}</td>
        <td>${p.seller}</td>`;
                tbody.appendChild(tr);
            });
            updateIconState();
        }

        // ===== фильтрация
        function collectFilters() {
            return {
                from: hasVal($("fDateFrom").value) ? new Date($("fDateFrom").value + "T00:00:00") : null,
                to: hasVal($("fDateTo").value) ? new Date($("fDateTo").value + "T23:59:59") : null,
                min: hasVal($("fAmtMin").value) ? Number($("fAmtMin").value) : null,
                max: hasVal($("fAmtMax").value) ? Number($("fAmtMax").value) : null,
                tag: $("fTag").value.trim().toLowerCase(),
                order: $("fOrder").value.trim().toLowerCase(),
                comment: $("fComment").value.trim().toLowerCase(),
            };
        }

        function applyFilters() {
            const f = collectFilters();
            const out = paymentsSrc.filter(p => {
                const d = parseRuDate(p.date);
                if (f.from && d < f.from) return false;
                if (f.to && d > f.to) return false;
                if (f.min !== null && Number(p.amount) < f.min) return false;
                if (f.max !== null && Number(p.amount) > f.max) return false;
                if (f.tag && !String(p.tag).toLowerCase().includes(f.tag)) return false;
                if (f.order && !String(p.order).toLowerCase().includes(f.order)) return false;
                if (f.comment && !String(p.comment).toLowerCase().includes(f.comment)) return false;
                return true;
            });
            render(out);
        }

        function resetFilters() {
            ["fDateFrom", "fDateTo", "fAmtMin", "fAmtMax", "fTag", "fOrder", "fComment"]
                .forEach(id => { $(id).value = ""; });
            render(paymentsSrc);
        }

        function updateIconState() {
            const f = collectFilters();
            const active =
                f.from || f.to || f.min !== null || f.max !== null ||
                f.tag || f.order || f.comment;
            document.getElementById("filtersReset").classList.toggle("active", !!active);
        }

        // события
        ["fDateFrom", "fDateTo", "fAmtMin", "fAmtMax", "fTag", "fOrder", "fComment"].forEach(id => {
            $(id).addEventListener("input", applyFilters);
            $(id).addEventListener("change", applyFilters);
        });
        document.getElementById("filtersReset").addEventListener("click", resetFilters);

        // старт
        render(paymentsSrc);
    </script>



    <script>
        // --- аккордеоны для 3 чипов ---
        function toggleChip(el, forceOpen = null) {
            const want = (forceOpen === null) ? !el.classList.contains('open') : !!forceOpen;
            el.classList.toggle('open', want);
            if (want) {
                const inp = el.querySelector('.chip__body input');
                if (inp) setTimeout(() => inp.focus(), 0);
            }
        }
        // открыть чип, если внутри уже есть значения
        function hydrateChipsByValues() {
            document.querySelectorAll('.chip--toggle').forEach(chip => {
                const hasValue = [...chip.querySelectorAll('input')].some(i => i.value && String(i.value).trim() !== '');
                chip.classList.toggle('open', hasValue);
            });
        }
        // клики по чипу — открывают/закрывают, клики по инпутам не сворачивают
        document.querySelectorAll('.chip--toggle').forEach(chip => {
            chip.addEventListener('click', e => {
                if (e.target.tagName === 'INPUT') return; // не сворачивать при наборе
                toggleChip(chip);
            });
        });

        // дернуть после первого render() и при каждом applyFilters()
        const _renderOrig = render;
        render = function (rows) { _renderOrig(rows); hydrateChipsByValues(); };

        // начальное состояние
        hydrateChipsByValues();
    </script>



</main>


{% endblock content %}